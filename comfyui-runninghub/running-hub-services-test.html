<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ComfyUI Runninghub API æµ‹è¯•é¡µé¢</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background-color: #f5f5f5;
    }

    .container {
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    h1 {
      color: #333;
      text-align: center;
      margin-bottom: 30px;
    }

    .section {
      margin-bottom: 30px;
      padding: 20px;
      border: 1px solid #ddd;
      border-radius: 8px;
      background-color: #fafafa;
    }

    .section h3 {
      color: #2c3e50;
      margin-top: 0;
    }

    button {
      background-color: #3498db;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      margin: 5px;
      font-size: 14px;
    }

    button:hover {
      background-color: #2980b9;
    }

    button:disabled {
      background-color: #bdc3c7;
      cursor: not-allowed;
    }

    input,
    textarea,
    select {
      width: 100%;
      padding: 8px;
      margin: 5px 0;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
    }

    textarea {
      height: 100px;
      resize: vertical;
    }

    .result {
      background-color: #f8f9fa;
      border: 1px solid #e9ecef;
      border-radius: 4px;
      padding: 15px;
      margin-top: 10px;
      white-space: pre-wrap;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      max-height: 300px;
      overflow-y: auto;
    }

    .success {
      border-color: #28a745;
      background-color: #d4edda;
    }

    .error {
      border-color: #dc3545;
      background-color: #f8d7da;
    }

    .loading {
      color: #6c757d;
      font-style: italic;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>ğŸš€ ComfyUI Runninghub API æµ‹è¯•é¡µé¢</h1>

    <!-- æ–‡ä»¶ä¸Šä¼ æµ‹è¯• -->
    <div class="section">
      <h3>ğŸ“ æ–‡ä»¶ä¸Šä¼ æµ‹è¯• (POST /v1/upload)</h3>
      <input type="file" id="fileInput" accept="image/*">
      <select id="fileType">
        <option value="image">image</option>
        <option value="video">video</option>
        <option value="audio">audio</option>
      </select>
      <button onclick="testUpload()">ä¸Šä¼ æ–‡ä»¶</button>
      <div id="uploadResult" class="result" style="display: none;"></div>
    </div>

    <!-- AI ç”Ÿå›¾æµ‹è¯• -->
    <div class="section">
      <h3>ğŸ¨ AI ç”Ÿå›¾æµ‹è¯• (POST /v1/generate/{workflow_name})</h3>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
        <div>
          <label>å·¥ä½œæµ:</label>
          <select id="workflowSelect" onchange="updateInputFields()">
            <option value="">åŠ è½½ä¸­...</option>
          </select>
          <small style="color: #666;">é€‰æ‹©è¦ä½¿ç”¨çš„å·¥ä½œæµ</small>
        </div>
        <div>
          <label>æç¤ºè¯:</label>
          <textarea id="prompt" placeholder="è¾“å…¥æç¤ºè¯">ä¸€ä¸ªç¾ä¸½çš„å¥³å­©ï¼Œé•¿å‘ï¼Œå¾®ç¬‘</textarea>
        </div>
        <!-- å›¾ç‰‡åç§°è¾“å…¥ï¼ˆä»…å¯¹å›¾ç‰‡æç¤ºå·¥ä½œæµæ˜¾ç¤ºï¼‰ -->
        <div id="imageNameField" style="display: none;">
          <label>å›¾ç‰‡åç§°:</label>
          <input type="text" id="imageName"
            placeholder="è¾“å…¥å›¾ç‰‡åç§°ï¼Œå¦‚ï¼š748d64d51b49f76b394b96f5a553a17c45dfa90872e73b86d33f712725db9bc7.jpg">
          <small style="color: #666;">éœ€è¦å…ˆä¸Šä¼ å›¾ç‰‡è·å–å›¾ç‰‡åç§°</small>
        </div>
        <!-- å›¾ç‰‡å°ºå¯¸è¾“å…¥ï¼ˆä»…å¯¹å›½æ½®çº¸é›•å·¥ä½œæµæ˜¾ç¤ºï¼‰ -->
        <div id="imageSizeField" style="display: none;">
          <label>å›¾ç‰‡å°ºå¯¸:</label>
          <div style="display: flex; gap: 10px;">
            <input type="number" id="width" value="1024" placeholder="å®½åº¦" style="flex: 1;">
            <input type="number" id="height" value="1536" placeholder="é«˜åº¦" style="flex: 1;">
          </div>
        </div>
      </div>
      <button onclick="testGenerate()">å¼€å§‹ç”Ÿæˆ</button>
      <div id="generateResult" class="result" style="display: none;"></div>
    </div>

    <!-- ä»»åŠ¡çŠ¶æ€æŸ¥è¯¢ -->
    <div class="section">
      <h3>ğŸ“Š ä»»åŠ¡çŠ¶æ€æŸ¥è¯¢ (GET /v1/tasks/{task_id})</h3>
      <input type="text" id="taskId" placeholder="è¾“å…¥ä»»åŠ¡ID">
      <button onclick="testTaskStatus()">æŸ¥è¯¢çŠ¶æ€</button>
      <div id="statusResult" class="result" style="display: none;"></div>
    </div>

    <!-- è·å–ä»»åŠ¡ç»“æœ -->
    <div class="section">
      <h3>ğŸ–¼ï¸ è·å–ä»»åŠ¡ç»“æœ (GET /v1/tasks/{task_id}/outputs)</h3>
      <input type="text" id="outputTaskId" placeholder="è¾“å…¥ä»»åŠ¡ID">
      <button onclick="testTaskOutputs()">è·å–ç»“æœ</button>
      <div id="outputResult" class="result" style="display: none;"></div>
    </div>

    <!-- æœåŠ¡å™¨çŠ¶æ€ -->
    <div class="section">
      <h3>ğŸ”§ æœåŠ¡å™¨çŠ¶æ€</h3>
      <button onclick="testServerStatus()">æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€</button>
      <div id="serverResult" class="result" style="display: none;"></div>
    </div>
  </div>

  <script>
    const API_BASE = 'http://localhost:8080';

    // æ˜¾ç¤ºç»“æœçš„é€šç”¨å‡½æ•°
    function showResult(elementId, data, isError = false) {
      const element = document.getElementById(elementId);
      element.style.display = 'block';
      element.className = `result ${isError ? 'error' : 'success'}`;
      element.textContent = JSON.stringify(data, null, 2);
    }

    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    function showLoading(elementId) {
      const element = document.getElementById(elementId);
      element.style.display = 'block';
      element.className = 'result loading';
      element.textContent = 'åŠ è½½ä¸­...';
    }

    // æ–‡ä»¶ä¸Šä¼ æµ‹è¯•
    async function testUpload() {
      const fileInput = document.getElementById('fileInput');
      const fileType = document.getElementById('fileType').value;

      if (!fileInput.files[0]) {
        alert('è¯·é€‰æ‹©ä¸€ä¸ªæ–‡ä»¶');
        return;
      }

      showLoading('uploadResult');

      const formData = new FormData();
      formData.append('file', fileInput.files[0]);
      formData.append('fileType', fileType);

      try {
        const response = await fetch(`${API_BASE}/v1/upload`, {
          method: 'POST',
          body: formData
        });
        const result = await response.json();
        showResult('uploadResult', result, !response.ok);
      } catch (error) {
        showResult('uploadResult', { error: error.message }, true);
      }
    }

    // æ›´æ–°è¾“å…¥å­—æ®µæ˜¾ç¤º
    function updateInputFields() {
      const workflowName = document.getElementById('workflowSelect').value;
      const imageNameField = document.getElementById('imageNameField');
      const imageSizeField = document.getElementById('imageSizeField');

      // æ ¹æ®å·¥ä½œæµç±»å‹æ˜¾ç¤ºä¸åŒçš„è¾“å…¥å­—æ®µ
      if (workflowName === 'image_prompt' || workflowName === 'image_edit') {
        imageNameField.style.display = 'block';
        imageSizeField.style.display = 'none';
      } else {
        imageNameField.style.display = 'none';
        imageSizeField.style.display = 'block';
      }
    }

    // AI ç”Ÿå›¾æµ‹è¯•
    async function testGenerate() {
      const prompt = document.getElementById('prompt').value;
      const workflowName = document.getElementById('workflowSelect').value;

      if (!prompt.trim()) {
        alert('è¯·è¾“å…¥æç¤ºè¯');
        return;
      }

      if (!workflowName) {
        alert('è¯·é€‰æ‹©å·¥ä½œæµ');
        return;
      }

      showLoading('generateResult');

      // æ ¹æ®å·¥ä½œæµç±»å‹æ„å»ºä¸åŒçš„payload
      let payload = { prompt: prompt };

      if (workflowName === 'image_prompt' || workflowName === 'image_edit') {
        const imageName = document.getElementById('imageName').value;
        if (!imageName.trim()) {
          alert('è¯·è¾“å…¥å›¾ç‰‡åç§°');
          return;
        }
        payload.image_name = imageName;
      } else {
        // å…¶ä»–å·¥ä½œæµï¼ˆå¦‚å›½æ½®çº¸é›•å·¥ä½œæµï¼‰
        const width = parseInt(document.getElementById('width').value) || 1024;
        const height = parseInt(document.getElementById('height').value) || 1536;
        payload.width = width;
        payload.height = height;
      }

      try {
        const endpoint = `${API_BASE}/v1/generate/${workflowName}`;
        console.log('å‘é€è¯·æ±‚åˆ°:', endpoint);
        console.log('è¯·æ±‚æ•°æ®:', payload);

        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 300000); // 5åˆ†é’Ÿè¶…æ—¶

        const response = await fetch(endpoint, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(payload),
          signal: controller.signal
        });

        clearTimeout(timeoutId);
        console.log('å“åº”çŠ¶æ€:', response.status);
        console.log('å“åº”å¤´:', response.headers);

        const result = await response.json();
        console.log('å“åº”æ•°æ®:', result);

        // å¦‚æœè¿”å›äº† taskIdï¼Œå¼€å§‹è½®è¯¢ä»»åŠ¡çŠ¶æ€
        if (result.taskId && result.status === 'PENDING') {
          showResult('generateResult', result, !response.ok);
          // å¼€å§‹è½®è¯¢ä»»åŠ¡çŠ¶æ€
          pollTaskStatus(result.taskId);
        } else {
          showResult('generateResult', result, !response.ok);
        }
      } catch (error) {
        console.error('è¯·æ±‚å¤±è´¥:', error);
        if (error.name === 'AbortError') {
          showResult('generateResult', { error: 'è¯·æ±‚è¶…æ—¶ï¼ˆ5åˆ†é’Ÿï¼‰', details: error.message }, true);
        } else {
          showResult('generateResult', { error: error.message, details: error.stack }, true);
        }
      }
    }

    // è½®è¯¢ä»»åŠ¡çŠ¶æ€
    async function pollTaskStatus(taskId) {
      const maxAttempts = 60; // æœ€å¤šè½®è¯¢60æ¬¡ï¼ˆ5åˆ†é’Ÿï¼‰
      let attempts = 0;

      const poll = async () => {
        try {
          const response = await fetch(`${API_BASE}/v1/tasks/${taskId}`);
          const result = await response.json();

          // æ›´æ–°ç»“æœæ˜¾ç¤º
          showResult('generateResult', {
            ...result,
            polling: true,
            attempts: attempts + 1,
            message: `æ­£åœ¨è½®è¯¢ä»»åŠ¡çŠ¶æ€... (${attempts + 1}/${maxAttempts})`
          }, !response.ok);

          if (result.status === 'SUCCESS' || result.status === 'FAILED') {
            // ä»»åŠ¡å®Œæˆï¼Œè·å–è¾“å‡ºç»“æœ
            if (result.status === 'SUCCESS') {
              try {
                const outputsResponse = await fetch(`${API_BASE}/v1/tasks/${taskId}/outputs`);
                const outputsResult = await outputsResponse.json();
                showResult('generateResult', {
                  ...result,
                  outputs: outputsResult.outputs,
                  polling: false,
                  message: 'ä»»åŠ¡å®Œæˆï¼'
                }, false);
              } catch (error) {
                showResult('generateResult', {
                  ...result,
                  polling: false,
                  message: 'ä»»åŠ¡å®Œæˆï¼Œä½†è·å–è¾“å‡ºå¤±è´¥'
                }, false);
              }
            } else {
              showResult('generateResult', {
                ...result,
                polling: false,
                message: 'ä»»åŠ¡å¤±è´¥'
              }, true);
            }
            return;
          }

          attempts++;
          if (attempts < maxAttempts) {
            // ç»§ç»­è½®è¯¢
            setTimeout(poll, 5000); // 5ç§’åå†æ¬¡è½®è¯¢
          } else {
            // è¶…æ—¶
            showResult('generateResult', {
              taskId: taskId,
              status: 'TIMEOUT',
              polling: false,
              message: 'è½®è¯¢è¶…æ—¶ï¼Œè¯·æ‰‹åŠ¨æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€'
            }, true);
          }
        } catch (error) {
          showResult('generateResult', {
            taskId: taskId,
            status: 'ERROR',
            polling: false,
            message: `è½®è¯¢å¤±è´¥: ${error.message}`
          }, true);
        }
      };

      // å¼€å§‹è½®è¯¢
      poll();
    }

    // ä»»åŠ¡çŠ¶æ€æŸ¥è¯¢
    async function testTaskStatus() {
      const taskId = document.getElementById('taskId').value;

      if (!taskId.trim()) {
        alert('è¯·è¾“å…¥ä»»åŠ¡ID');
        return;
      }

      showLoading('statusResult');

      try {
        const response = await fetch(`${API_BASE}/v1/tasks/${taskId}`);
        const result = await response.json();
        showResult('statusResult', result, !response.ok);
      } catch (error) {
        showResult('statusResult', { error: error.message }, true);
      }
    }

    // è·å–ä»»åŠ¡ç»“æœ
    async function testTaskOutputs() {
      const taskId = document.getElementById('outputTaskId').value;

      if (!taskId.trim()) {
        alert('è¯·è¾“å…¥ä»»åŠ¡ID');
        return;
      }

      showLoading('outputResult');

      try {
        const response = await fetch(`${API_BASE}/v1/tasks/${taskId}/outputs`);
        const result = await response.json();
        showResult('outputResult', result, !response.ok);
      } catch (error) {
        showResult('outputResult', { error: error.message }, true);
      }
    }

    // æœåŠ¡å™¨çŠ¶æ€æ£€æŸ¥
    async function testServerStatus() {
      showLoading('serverResult');

      try {
        const response = await fetch(`${API_BASE}/v1/upload`, {
          method: 'OPTIONS'
        });
        const result = {
          status: response.status,
          statusText: response.statusText,
          server: 'FastAPI Server',
          timestamp: new Date().toISOString()
        };
        showResult('serverResult', result, !response.ok);
      } catch (error) {
        showResult('serverResult', {
          error: 'æœåŠ¡å™¨è¿æ¥å¤±è´¥',
          details: error.message,
          suggestion: 'è¯·ç¡®ä¿æœåŠ¡å™¨æ­£åœ¨è¿è¡Œåœ¨ http://localhost:8080'
        }, true);
      }
    }

    // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
    // è·å–å·¥ä½œæµåˆ—è¡¨
    async function loadWorkflows() {
      try {
        const response = await fetch(`${API_BASE}/v1/workflows`);
        const result = await response.json();

        if (result.workflows) {
          const select = document.getElementById('workflowSelect');
          select.innerHTML = '';

          result.workflows.forEach(workflow => {
            const option = document.createElement('option');
            option.value = workflow.name;
            option.textContent = workflow.display_name;
            select.appendChild(option);
          });

          // å·¥ä½œæµåŠ è½½å®Œæˆåæ›´æ–°å­—æ®µæ˜¾ç¤º
          updateInputFields();
        }
      } catch (error) {
        console.error('è·å–å·¥ä½œæµåˆ—è¡¨å¤±è´¥:', error);
      }
    }

    document.addEventListener('DOMContentLoaded', function () {
      console.log('ComfyUI Runninghub API æµ‹è¯•é¡µé¢å·²åŠ è½½');
      console.log('API åŸºç¡€åœ°å€:', API_BASE);
      loadWorkflows();

      // ç¡®ä¿åˆå§‹çŠ¶æ€æ­£ç¡®
      updateInputFields();
    });
  </script>
</body>

</html>